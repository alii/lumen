name: test262 conformance

on:
  push:
    branches: [master]
  schedule:
    # Run at midday UK time every day
    # UK is UTC+0 in winter, UTC+1 in summer (BST)
    # 12:00 BST = 11:00 UTC, 12:00 GMT = 12:00 UTC
    # Use 12:00 UTC as a reasonable midday approximation
    - cron: '0 12 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  test262:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          # Need full history to check for changes
          fetch-depth: 2

      - name: Check for changes since last run
        id: changes
        run: |
          # On push events, always run. On schedule/dispatch, check for changes.
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Push event, running test262"
          elif git diff --quiet HEAD~1 -- src/ test/ gleam.toml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No source changes detected, skipping test262 run"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Source changes detected, running test262"
          fi

      - uses: erlef/setup-beam@v1
        if: steps.changes.outputs.changed == 'true'
        with:
          otp-version: "28"
          gleam-version: "1.14.0"
          rebar3-version: "3"

      - name: Setup Python
        if: steps.changes.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        if: steps.changes.outputs.changed == 'true'
        run: pip install matplotlib

      - name: Build
        if: steps.changes.outputs.changed == 'true'
        run: gleam deps download

      - name: Run test262 suite
        if: steps.changes.outputs.changed == 'true'
        run: |
          TEST262_EXEC=1 RESULTS_FILE=.github/test262/results.json gleam test
        timeout-minutes: 60

      - name: Generate conformance chart
        if: steps.changes.outputs.changed == 'true'
        run: |
          python3 .github/scripts/generate_chart.py --add-result .github/test262/results.json

      - name: Commit results
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/test262/history.json .github/test262/conformance.png
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update test262 conformance: $(python3 -c "
          import json
          with open('.github/test262/results.json') as f:
              r = json.load(f)
          print(f\"{r['percent']}% ({r['pass']}/{r['tested']})\")
          ")"
            git push
          fi
