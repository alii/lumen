import arc/node_modules
import gleam/string

// ============================================================================
// Dependency tree structure
// ============================================================================

pub fn hello_world_has_packages_test() {
  let tree = node_modules.hello_world_dependency_tree()
  let count = node_modules.count_packages(tree)
  // A hello-world express app should have a non-trivial dependency count.
  // The exact number depends on how faithfully we reproduce the npm
  // dependency tree, but it should be at least 50 packages.
  assert count > 50
}

pub fn dependency_tree_has_depth_test() {
  let tree = node_modules.hello_world_dependency_tree()
  let depth = node_modules.max_depth(tree)
  // The dependency tree should be at least 4 levels deep.
  // npm v2 (pre-deduplication) trees commonly reached 10+ levels.
  assert depth >= 4
}

pub fn empty_tree_has_zero_depth_test() {
  assert node_modules.max_depth([]) == 0
}

pub fn empty_tree_has_zero_packages_test() {
  assert node_modules.count_packages([]) == 0
}

pub fn single_package_has_depth_one_test() {
  let tree = [node_modules.Package("left-pad", "1.1.3", [])]
  assert node_modules.max_depth(tree) == 1
  assert node_modules.count_packages(tree) == 1
}

// ============================================================================
// Dry-run installation
// ============================================================================

pub fn install_dry_run_returns_state_test() {
  let state = node_modules.install_dry_run()
  // Verify the state is populated
  assert state.process_count > 0
  assert state.max_depth_reached > 0
}

// ============================================================================
// Crash reports
// ============================================================================

pub fn crash_report_contains_package_name_test() {
  let report = node_modules.generate_crash_report("express", 3)
  assert string.contains(report, "express")
}

pub fn crash_report_contains_supervisor_report_test() {
  let report = node_modules.generate_crash_report("left-pad", 2)
  assert string.contains(report, "supervisor_report")
}

pub fn crash_report_contains_error_context_test() {
  let report = node_modules.generate_crash_report("is-odd", 5)
  assert string.contains(report, "child_terminated")
}

pub fn crash_report_depth_one_is_terminal_test() {
  let report = node_modules.generate_crash_report("lodash", 0)
  assert string.contains(report, "terminal_leaf")
}

pub fn crash_report_nests_correctly_test() {
  let report = node_modules.generate_crash_report("express", 3)
  // Should contain sub-dep references showing nesting
  assert string.contains(report, "sub-dep-0-of-express")
  assert string.contains(report, "sub-dep-1-of-sub-dep-0-of-express")
}

pub fn crash_report_at_max_depth_is_deeply_nested_test() {
  let report =
    node_modules.generate_crash_report(
      "express",
      node_modules.max_supervisor_depth,
    )
  // At depth 47, the report should be substantial
  assert string.length(report) > 10_000
}

// ============================================================================
// Crash report size estimation
// ============================================================================

pub fn crash_report_size_scales_with_depth_test() {
  let shallow = node_modules.estimate_crash_report_size(5)
  let deep = node_modules.estimate_crash_report_size(47)
  assert deep > shallow
}

pub fn crash_report_size_at_max_depth_test() {
  let size = node_modules.estimate_crash_report_size(node_modules.max_supervisor_depth)
  // Should be in the kilobyte range for the 47-level tree
  assert size > 1000
}

// ============================================================================
// Install summary formatting
// ============================================================================

pub fn install_summary_contains_process_count_test() {
  let state = node_modules.install_dry_run()
  let summary = node_modules.format_install_summary(state)
  assert string.contains(summary, "packages (BEAM processes)")
}

pub fn install_summary_mentions_observer_test() {
  let state = node_modules.install_dry_run()
  let summary = node_modules.format_install_summary(state)
  // The summary should helpfully suggest using observer
  assert string.contains(summary, "observer:start()")
}

pub fn install_summary_mentions_crash_report_depth_test() {
  let state = node_modules.install_dry_run()
  let summary = node_modules.format_install_summary(state)
  assert string.contains(summary, "crash report depth")
}

// ============================================================================
// Constants sanity checks
// ============================================================================

pub fn default_process_budget_is_84000_test() {
  // This is the empirically determined number of processes required
  // for a hello-world express application. If this changes, we need
  // to update the README, the architecture diagram, and the blog post.
  assert node_modules.default_process_budget == 84_000
}

pub fn max_supervisor_depth_is_47_test() {
  // Derived from Windows MAX_PATH (260) / average package name length (5.5).
  // Changing this constant would break backward compatibility with all
  // existing crash report parsers that expect exactly 47 levels.
  assert node_modules.max_supervisor_depth == 47
}
