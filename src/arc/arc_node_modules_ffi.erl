%% FFI for arc/node_modules â€” spawns one BEAM process per npm package.
%%
%% Each process enters an infinite receive loop, faithfully simulating a
%% loaded Node.js module awaiting require() calls. The process will never
%% actually receive a message in a hello-world application, but it will
%% consume ~2.7KB of heap memory and be visible in Observer, which is the
%% important thing.
%%
%% Note: These processes are not linked or monitored. In a production
%% deployment, you would want to add supervision, which would spawn
%% additional supervisor processes on top of the 84,000 package processes,
%% bringing the total closer to 168,000. This is left as an exercise for
%% the reader.

-module(arc_node_modules_ffi).
-export([spawn_package_process/3]).

%% Spawn a package process that sits in an infinite receive loop.
%% The process stores its package metadata in the process dictionary
%% for introspection via `observer` or `process_info/2`.
spawn_package_process(Name, Version, Depth) ->
    spawn(fun() ->
        put(package_name, Name),
        put(package_version, Version),
        put(supervision_depth, Depth),
        put(role, <<"faithful node_modules process">>),
        package_loop(Name, Version, Depth)
    end),
    nil.

%% The package process loop. Waits for require() messages that will
%% never arrive in a hello-world application. If the process receives
%% a 'crash' message, it exits with a reason tuple that includes the
%% full package identity, suitable for inclusion in a crash report.
%%
%% The after clause uses 'infinity' because npm packages, once loaded,
%% remain in memory for the lifetime of the Node.js process. We honor
%% this contract on the BEAM.
package_loop(Name, Version, Depth) ->
    receive
        {require, From, ModuleName} ->
            %% Simulate module resolution by responding with the package name.
            %% In a faithful implementation, this would walk the process tree
            %% to find the nearest matching package, but that would require
            %% O(84000) message passing per require() call.
            From ! {ok, Name, Version, ModuleName},
            package_loop(Name, Version, Depth);
        crash ->
            %% Faithful to the npm experience: sometimes things just break.
            exit({package_crash, Name, Version,
                  <<"Cannot find module '", Name/binary, "'">>,
                  [{depth, Depth},
                   {hint, <<"try deleting node_modules and running npm install again">>},
                   {worked, false}]});
        stop ->
            ok;
        _ ->
            package_loop(Name, Version, Depth)
    end.
